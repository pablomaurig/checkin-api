version: '3.3'

services:
  postgres:
    image: postgres:13
    environment:
      - POSTGRES_DB=hotel
      - POSTGRES_USER=pablo
      - POSTGRES_PASSWORD=admin123
    ports:
      - 5432:5432
    volumes:
      - ./data/postgres_data:/var/lib/postgresql/data

  pgadmin:
    image: dpage/pgadmin4
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@mail.com
      - PGADMIN_DEFAULT_PASSWORD=root
    ports:
      - 5050:80

  orion:
    image: fiware/orion
    hostname: orion
    container_name: fiware-orion
    depends_on:
      - mongo-db
    ports:
      - '1026:1026'
    command: -dbhost mongo-db -logLevel DEBUG -noCache

  cygnus:
    image: fiware/cygnus-ngsi
    hostname: cygnus
    container_name: fiware-cygnus
    networks:
      - default
    ports:
      - '5055:5055'
      - '5080:5080'
    environment:
      #- 'CYGNUS_POSTGRESQL_HOST=postgres' # Hostname of the PostgreSQL server used to persist historical context data
      #- 'CYGNUS_POSTGRESQL_PORT=5432' # Port that the PostgreSQL server uses to listen to commands
      #- 'CYGNUS_POSTGRESQL_USER=pablo' # Username for the PostgreSQL database user
      #- 'CYGNUS_POSTGRESQL_PASS=admin123' # Password for the PostgreSQL database user
      #- 'CYGNUS_POSTGRESQL_DATABASE=hotel' #DATABASE
      #- 'CYGNUS_POSTGRESQL_ENABLE_CACHE=true' # Switch to enable caching within the PostgreSQL configuration
      #- 'CYGNUS_POSTGRESQL_SERVICE_PORT=5055' # The port the agent.conf is configured for
      #- 'CYGNUS_LOG_LEVEL=DEBUG' # The logging level for Cygnus
      #- 'CYGNUS_SERVICE_PORT=5055' # Notification Port that Cygnus listens to for Postgres subscriptions
      #- 'CYGNUS_API_PORT=5080' # Port that Cygnus listens on for operational reasons
      - "CYGNUS_MYSQL_SERVICE_PORT=5055"
      - "CYGNUS_MYSQL_HOST=mysql"
      - "CYGNUS_MYSQL_PORT=3306"
      - "CYGNUS_MYSQL_USER=root"
      - "CYGNUS_MYSQL_PASS=${MYSQL_ROOT_PASSWORD}"
      - "CYGNUS_MYSQL_BATCH_SIZE=1"
      - "CYGNUS_LOG_LEVEL=INFO"
      - "CYGNUS_SERVICE_PORT=5055"
      - "CYGNUS_API_PORT=${CYGNUS_API_PORT}"
    healthcheck:
      test: curl --fail -s http://localhost:${CYGNUS_API_PORT}/v1/version || exit 1
    depends_on:
      - mariadb

  mongo-db:
    image: mongo:3.6
    hostname: mongo-db
    container_name: db-mongo
    ports:
      - '27017:27017'
    command: --bind_ip_all --smallfiles
    volumes:
      - ./data/mongo-db:/data

  adminmongo:
    image: mrvautin/adminmongo
    ports:
      - ${ADMIN_MONGO_PORT:-1234}:1234
    environment:
      - HOST=0.0.0.0

  grafana:
    image: grafana/grafana-oss
    ports:
      - ${GRAFANA_PORT}:3000
    environment:
      #crate-datasource,Postgres
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-worldmap-panel,grafana-clock-panel,grafana-worldmap-panel
    volumes:
      - ./data/grafana-storage:/var/lib/grafana #admin - ORT2022!

  mariadb:
    image: mariadb:10.8.3
    container_name: mysql
    restart: always
    environment:
        - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
        - MYSQL_DATABASE=${MYSQL_DATABASE}
    volumes:
        - ./data/mysql:/var/lib/mysql
    ports:
        - 5004:3306